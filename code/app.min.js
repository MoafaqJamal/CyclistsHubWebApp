const weatherKey="eccf22da55066e5d6f4d1b4f4bcc8dde",collectionID="events",s3bucket="https://s3712755-cw2-s3.s3.amazonaws.com/",icon={bikeShare:s3bucket+"bikeshare.png",bike:s3bucket+"bike.png",drink:s3bucket+"drink.png"},melbLoc={lat:-37.8136,lng:144.9631};var firebaseConfig={apiKey:"AIzaSyAQqXzE9r5h9VYoKuQ17pFQ5eIX1U4DxNM",authDomain:"cc-cw2.firebaseapp.com",databaseURL:"https://cc-cw2.firebaseio.com",projectId:"cc-cw2",storageBucket:"cc-cw2.appspot.com",messagingSenderId:"173260217704",appId:"1:173260217704:web:d6fb06c77869d416444add",measurementId:"G-0SB74NH314"};firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),db=firebase.firestore();function weatherNow(){$.getJSON("https://ipapi.co/json/").done(function(e){$.getJSON("https://api.openweathermap.org/data/2.5/weather?lat="+e.latitude+"&lon="+e.longitude+"&appid="+weatherKey+"&units=metric").done(function(e){if(3.6*e.wind.speed>30)var t="It's too windy to cycle!";else t="It's not that windy to cycle!";document.getElementById("weather").innerHTML=e.weather[0].description+" "+Math.round(e.main.temp)+"&deg; "+Math.round(3.6*e.wind.speed)+"km/h wind speed",document.getElementById("windy").innerHTML=t})})}function initMap(){var e={zoom:12,center:new google.maps.LatLng(melbLoc.lat,melbLoc.lng)},t=new google.maps.Map(document.getElementById("map"),e),n=new google.maps.InfoWindow;function o(e){var o=new google.maps.Marker({position:e.location,map:t,icon:e.icon,title:e.title});o.addListener("click",function(){n.setContent(e.title),n.open(t,o)})}var a=document.getElementById("menu").value;console.log(a+" selected");var l=s3bucket+"Drinking_fountains.xml",s=new XMLHttpRequest;s.onreadystatechange=function(){4==this.readyState&&200==this.status&&function(e){xmlDoc=e.responseXML,"BikeShop"==a&&bikeShopReq();if("DrinkingFountain"==a){var t=xmlDoc.getElementsByTagName("row");for(i=0;i<t.length;i++){var n=t[i].getElementsByTagName("lat")[0].childNodes[0].nodeValue,l=t[i].getElementsByTagName("lon")[0].childNodes[0].nodeValue,s={location:new google.maps.LatLng(n,l),title:"Drinking Fountain",icon:icon.drink};o(s)}}"BikeShare"==a&&$.getJSON("https://data.melbourne.vic.gov.au/resource/vrwc-rwgm.json?$$app_token=UPwcXKkm4fIbcEmoRCjfxGAC0").done(function(e){$.getJSON("https://data.melbourne.vic.gov.au/resource/tdvh-n9dv.json?$$app_token=UPwcXKkm4fIbcEmoRCjfxGAC0").done(function(t){for(var n=0;n<e.length;n++)for(var a=0;a<t.length;a++)if(e[n].station_id==t[a].station_id){var i=e[n].lat,l=e[n].lon,s=e[n].name+"\n Capacity: "+t[a].capacity+"\n Available bikes: "+t[a].available_bikes+"\n Empty docks: "+t[a].empty_docks,c={location:new google.maps.LatLng(i,l),title:s,icon:icon.bikeShare};o(c)}})})}(this)},s.open("GET",l,!0),s.send()}function bikeShopReq(){var e,t;function n(e,t){if(t==google.maps.places.PlacesServiceStatus.OK)for(var n=0;n<e.length;n++){e[n];a(e[n])}}e=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(melbLoc.lat,melbLoc.lng),zoom:12}),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(o){t={lat:o.coords.latitude,lng:o.coords.longitude},e.setCenter(t);var a={location:new google.maps.LatLng(t.lat,t.lng),radius:"5000",keyword:["bike shop"]};service=new google.maps.places.PlacesService(e),service.nearbySearch(a,n)});var o=new google.maps.InfoWindow;function a(t){var n=new google.maps.Marker({position:t.geometry.location,map:e,icon:icon.bike,title:t.name});n.addListener("click",function(){o.setContent(t.name),o.open(e,n)})}}function firebaseAuth(){const e=document.getElementById("loginResp"),t=document.getElementById("logout"),n=document.getElementById("login-form"),o=document.getElementById("login-email"),a=document.getElementById("login-password"),i=document.getElementById("addContentBtn");auth.onAuthStateChanged(n=>{n?(e.innerHTML="user logged in with email: "+n.email,t.style.display="block",i.style.display="block",firebaseAddContent()):e.innerHTML="No user logged in!"}),n.addEventListener("submit",e=>{e.preventDefault();const l=o.value,s=a.value;n.reset(),auth.signInWithEmailAndPassword(l,s).then(e=>{}).catch(e=>{alert("Login credential is not right!"),t.style.display="none",i.style.display="none",firebaseAddContent(),auth.signOut()})}),t.addEventListener("click",e=>{e.preventDefault(),auth.currentUser&&(alert("User Log out"),auth.signOut(),t.style.display="none",i.style.display="none",firebaseAddContent()),n.reset()})}function firebaseAddContent(){var e,t=document.getElementById("fileupload"),n=document.getElementById("progress"),o=document.querySelector("#addContent-form");"none"==o.style.display?o.style.display="block":o.style.display="none",t.addEventListener("change",function(t){var o=t.target.files[0];e=o.name,firebase.storage().ref("images/"+e).put(o).on("state_changed",function(e){var t=e.bytesTransferred/e.totalBytes*100;n.value=t},function(e){console.log("Something went wrong")},function(){alert("File Uploaded"),n.value=0,console.log("File Uploaded")})}),o.addEventListener("submit",t=>{t.preventDefault();var n=o.title.value,a=o.description.value,i=parseFloat(o.locationLat.value),l=parseFloat(o.locationLng.value);null!=e?firebase.storage().ref("images/"+e).getDownloadURL().then(t=>{db.collection(collectionID).add({timeCreated:firebase.firestore.FieldValue.serverTimestamp(),title:n,description:a,location:new firebase.firestore.GeoPoint(i,l),imageNAME:e,image:t}).then(()=>{console.log("added to DB"),e=null,alert("Details have been added")}).catch(e=>{console.log(e.message)})}):db.collection(collectionID).add({timeCreated:firebase.firestore.FieldValue.serverTimestamp(),title:n,description:a,location:new firebase.firestore.GeoPoint(i,l)}).then(()=>{console.log("added to DB"),alert("Details have been added")}).catch(e=>{console.log(e.message)}),o.reset()})}function displayEvents(){var e=document.querySelector(".eventsToShow");const t=document.querySelector("#mapid");var n=L.map(t).setView([melbLoc.lat,melbLoc.lng],10);L.tileLayer("https://api.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibW9hZmFxIiwiYSI6ImNrMXUyZGcycjBlYWkzbW8wbmI0c3lrbGUifQ.5LaqXBC2IoMotWH1Kpttqg").addTo(n),db.collection(collectionID).orderBy("timeCreated","desc").onSnapshot(t=>{!function(t){let o="";t.forEach(e=>{var t=null!=e.data().image?e.data().image:s3bucket+"noimg.png",a=e.data().location._lat,i=e.data().location._long;!function(e,t,o){var a="<a href=#"+o.split(" ").join("")+">"+o+"</a>";L.marker([e,t]).addTo(n).bindPopup(a).openPopup()}(a,i,e.data().title);const l=`\n          <li>\n          <a style="color: black;" name="${e.data().title.split(" ").join("")}" <div class="collapsible-header grey lighten-4">${e.data().title}</div></a>\n          <div class="collapsible-body white">\n          <div>\n          <img src="${t}" height="350px" style="float:left;padding:10px;">\n          <p>${e.data().description}</p>\n          <a href="https://www.google.com/maps/dir//${a},${i}/@15z/data=!4m2!4m1!3e2" target="_blank"><p>CLICK to get Direction to location</p></a>\n          <code>postID: ${e.id}</code><br>\n          <code>CreatedOn: ${function(e){var t=new Date(1e3*e),n=t.getFullYear(),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],a=t.getDate(),i=t.getHours(),l=t.getMinutes(),s=t.getSeconds();return a+" "+o+" "+n+" "+i+":"+l+":"+s}(e.data().timeCreated.seconds)}</code>\n          <div style="clear:both;"></div>\n          </div>\n          </div>\n          </li>\n          `;o+=l}),e.innerHTML=o}(t.docs)},e=>{console.log(e.message)})}const post2Delete=document.getElementById("post2Delete"),btnPost2Delete=document.getElementById("btnPost2Delete");btnPost2Delete.addEventListener("click",e=>{e.preventDefault();var t=db.collection(collectionID).doc(post2Delete.value);t.get().then(e=>{e.exists?(firebase.storage().ref("images/"+e.get("imageNAME")).delete().then(()=>{console.log("Image deleted")}).catch(e=>{console.log("Can't find image with this post",e.message)}),t.delete(),post2Delete.value="",alert("Post has been deleted")):alert("Post doesn't exist")}).catch(e=>{console.log("No such document exist",e.message)})});
